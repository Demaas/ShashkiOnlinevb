<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Шашки Онлайн</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Модальное окно входа -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <h2>Вход в игру</h2>
        <p>Введите ваш никнейм для начала игры</p>
        <input
          type="text"
          id="usernameInput"
          placeholder="Введите ваш ник"
          maxlength="15"
        />
        <button id="startGameButton" class="start-button">Начать игру</button>
      </div>
    </div>

    <!-- Модальное окно для никнейма -->
    <div id="nicknameModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Новая игра</h3>
        <p>Введите ваш никнейм:</p>
        <input
          type="text"
          id="nicknameInput"
          placeholder="Ваш никнейм"
          maxlength="15"
        />
        <div class="modal-buttons">
          <button onclick="confirmNickname()" style="background-color: #2196F3;">
            Начать игру
          </button>
        </div>
      </div>
    </div>

    <!-- Модальное окно подтверждения перезапуска -->
    <div id="restartModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Новая игра</h3>
        <p id="restartMessage">Противник предлагает начать новую игру. Согласны?</p>
        <div class="modal-buttons">
          <button onclick="confirmRestart()" style="background-color: #4CAF50;">Да</button>
          <button onclick="declineRestart()" style="background-color: #f44336;">Нет</button>
        </div>
      </div>
    </div>

    <!-- Модальное окно завершения игры -->
    <div id="gameOverModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3>Игра Завершена!</h3>
        <p id="gameOverMessage"></p>
        <div class="gif-container">
          <img
            src="https://media1.tenor.com/m/w_PLu8IF2Y8AAAAd/sml-joseph.gif"
            alt="Celebration"
            class="celebration-gif"
            style="max-width: 200px; border-radius: 10px; margin: 10px 0;"
          />
        </div>
        <div class="modal-buttons">
          <button onclick="startNewGame()" style="background-color: #2196F3;">Новая игра</button>
        </div>
      </div>
    </div>

    <div class="container">
      <h1>
        <img src="shasemi.png" alt="Шашки" class="title-icon" /> Шашки Онлайн
      </h1>
      
      <!-- Обновленная информация об игроках с фото и индикатором хода -->
      <div class="players-info">
        <div class="player-info" id="whitePlayer">
          <img src="shabe.png" alt="Белые" class="player-icon">
          <span class="player-nickname" id="whiteNickname">Ожидание игрока...</span>
          <span class="turn-indicator">⬅️ Ход</span>
        </div>
        <div class="player-info" id="blackPlayer">
          <img src="shach.png" alt="Черные" class="player-icon">
          <span class="player-nickname" id="blackNickname">Ожидание игрока...</span>
          <span class="turn-indicator">⬅️ Ход</span>
        </div>
      </div>

      <div class="game-container">
        <div id="status">Загрузка...</div>
        <div class="board" id="board"></div>

        <!-- Кнопки управления игрой - ОСТАВЛЯЕМ ТОЛЬКО КНОПКУ "НИЧЬЯ?" -->
        <div class="game-controls">
          <button class="control-button draw-offer-btn" onclick="offerDraw()">
            Ничья?
          </button>
        </div>

        <!-- Модальное окно для предложения ничьи -->
        <div id="drawOfferModal" class="modal" style="display: none">
          <div class="modal-content">
            <h3>Предложение ничьи</h3>
            <p id="drawOfferText">Игрок предлагает ничью</p>
            <div class="modal-buttons">
              <button onclick="acceptDrawOffer()" style="background-color: #4CAF50;">Да</button>
              <button onclick="rejectDrawOffer()" style="background-color: #f44336;">Нет</button>
            </div>
          </div>
        </div>

        <!-- Блок рестарта игры (скрываем, т.к. используем модальное окно) -->
        <div
          id="restartContainer"
          class="restart-container"
          style="display: none"
        >
          <h2
            style="
              color: #ffeb3b;
              margin-bottom: 20px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            "
          >
            Игра Завершена!
          </h2>
          <div class="gif-container">
            <img
              src="https://media1.tenor.com/m/w_PLu8IF2Y8AAAAd/sml-joseph.gif"
              alt="Celebration"
              class="celebration-gif"
            />
          </div>
        </div>
      </div>
    </div>

    <script>
      // Функции для модального окна перезапуска
      function showRestartConfirmation(requestedBy) {
        const modal = document.getElementById('restartModal');
        const message = document.getElementById('restartMessage');
        
        if (modal && message) {
          const color = requestedBy === 'white' ? 'белые' : 'черные';
          message.textContent = `Игрок (${color}) предлагает начать новую игру. Согласны?`;
          modal.style.display = 'flex';
        }
      }

      function hideRestartModal() {
        const modal = document.getElementById('restartModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function confirmRestart() {
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
          window.ws.send(JSON.stringify({
            type: 'confirmRestart'
          }));
        }
        hideRestartModal();
      }

      function declineRestart() {
        hideRestartModal();
      }

      // Функции для обновления информации об игроках
      function updatePlayersInfo() {
        const whitePlayer = document.getElementById('whitePlayer');
        const blackPlayer = document.getElementById('blackPlayer');
        
        if (!whitePlayer || !blackPlayer) return;
        
        // Сбрасываем индикаторы
        whitePlayer.classList.remove('active');
        blackPlayer.classList.remove('active');
        
        // Активируем текущего игрока
        if (window.currentPlayer === 'white') {
          whitePlayer.classList.add('active');
        } else {
          blackPlayer.classList.add('active');
        }
      }

      function setPlayerNickname(color, nickname) {
        const element = document.getElementById(color + 'Nickname');
        if (element) {
          element.textContent = nickname || 'Ожидание игрока...';
        }
      }

      function showGameOverModal(winner, winnerColor) {
        const modal = document.getElementById('gameOverModal');
        const messageElement = document.getElementById('gameOverMessage');
        if (modal && messageElement) {
          if (winner === 'draw') {
            messageElement.textContent = 'Ничья!';
          } else {
            const colorText = winnerColor === 'white' ? 'белые' : 'черные';
            messageElement.textContent = `Победил ${winner} (${colorText})`;
          }
          modal.style.display = 'flex';
        }
      }

      function hideGameOverModal() {
        const modal = document.getElementById('gameOverModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function startNewGame() {
        console.log("Starting new game...");
        hideGameOverModal();
        
        // Показываем окно для ввода ника
        showNicknameModal();
        
        // Сбрасываем игровое состояние
        if (window.resetGame) {
          window.resetGame();
        }
      }

      // Функции для предложения ничьи
      function offerDraw() {
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
          window.ws.send(JSON.stringify({
            type: 'drawOffer'
          }));
          if (window.updateStatus) {
            window.updateStatus('Предложение ничьи отправлено');
          }
        }
      }

      function acceptDrawOffer() {
        const modal = document.getElementById('drawOfferModal');
        if (modal) modal.style.display = 'none';
        
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
          window.ws.send(JSON.stringify({
            type: 'drawResponse',
            accept: true
          }));
        }
      }

      function rejectDrawOffer() {
        const modal = document.getElementById('drawOfferModal');
        if (modal) modal.style.display = 'none';
        
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
          window.ws.send(JSON.stringify({
            type: 'drawResponse',
            accept: false
          }));
        }
        if (window.updateStatus) {
          window.updateStatus('Предложение ничьи отклонено');
        }
      }

      function showDrawOfferModal(opponentNickname) {
        const modal = document.getElementById('drawOfferModal');
        const message = document.getElementById('drawOfferText');
        if (modal && message) {
          message.textContent = `Игрок ${opponentNickname} предлагает ничью`;
          modal.style.display = 'flex';
        }
      }

      function hideDrawOfferModal() {
        const modal = document.getElementById('drawOfferModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // Глобальные функции для модальных окон
      function showNicknameModal() {
        const modal = document.getElementById('nicknameModal');
        if (modal) {
          modal.style.display = 'flex';
          const nicknameInput = document.getElementById('nicknameInput');
          if (nicknameInput) {
            nicknameInput.value = window.playerNickname || '';
            nicknameInput.focus();
          }
        }
      }

      function hideNicknameModal() {
        const modal = document.getElementById('nicknameModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function confirmNickname() {
        const nicknameInput = document.getElementById('nicknameInput');
        const nickname = nicknameInput.value.trim();
        
        if (nickname) {
          if (window.playerNickname !== undefined) {
            window.playerNickname = nickname;
          }
          
          // Устанавливаем никнейм для соответствующего игрока
          if (window.playerColor) {
            setPlayerNickname(window.playerColor, nickname);
          }
          
          hideNicknameModal();
          
          // Инициализация игры после установки ника
          if (window.resetGame) {
            window.resetGame();
          }
          
          // Уведомление сервера о новом игроке
          if (window.ws && window.ws.readyState === WebSocket.OPEN) {
            window.ws.send(JSON.stringify({
              type: 'setNickname',
              nickname: nickname
            }));
          }

          if (window.updateStatus) {
            window.updateStatus('Новая игра начинается...');
          }
        } else {
          alert('Пожалуйста, введите никнейм');
        }
      }

      // Инициализация при загрузке
      document.addEventListener('DOMContentLoaded', function() {
        // Обработчики для модального окна никнейма
        const nicknameInput = document.getElementById('nicknameInput');
        
        if (nicknameInput) {
          nicknameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              confirmNickname();
            }
          });
        }

        // Обработчик для кнопки рестарта
        const restartBtn = document.getElementById('restartButton');
        if (restartBtn) {
          restartBtn.addEventListener('click', function() {
            const restartContainer = document.getElementById('restartContainer');
            if (restartContainer) restartContainer.style.display = 'none';
            
            // Начинаем новую игру
            showNicknameModal();
          });
        }

        // Обработчик для кнопки начала игры
        const startGameBtn = document.getElementById('startGameButton');
        const usernameInput = document.getElementById('usernameInput');
        
        if (startGameBtn && usernameInput) {
          startGameBtn.addEventListener('click', function() {
            const username = usernameInput.value.trim();
            if (username) {
              // Скрываем модальное окно входа
              const loginModal = document.getElementById('loginModal');
              if (loginModal) loginModal.style.display = 'none';
              
              // Устанавливаем никнейм
              if (window.playerNickname !== undefined) {
                window.playerNickname = username;
              }
              
              // Инициализируем игру
              if (window.initGame) {
                window.initGame();
              }
              
              // Отправляем никнейм на сервер
              if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                window.ws.send(JSON.stringify({
                  type: 'setNickname',
                  nickname: username
                }));
              }
            } else {
              alert('Пожалуйста, введите никнейм');
            }
          });

          usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              startGameBtn.click();
            }
          });
        }
      });
    </script>
    <script src="script.js"></script>
  </body>
</html>
